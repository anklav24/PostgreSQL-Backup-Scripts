Записки о 1С и PostgreSQL

Сегодня в программе!

Обновление 1С
Восстановление баз разными путями.
Тестирование и обслуживание баз.
Тюнинг серверов 1С и PostgreSQL

Обновление 1С (Сервер, платформа, конфигурации)

Проверил наличие бэкапов Windows backup server, PostgreSQL, можно еще сделать бекапы через 1С в .dt файлы.
Сделал снепшоты в гипервизоре серверов 1C и SQL
Проверил количество занятой оперативной памяти на серверах 1С и PostgreSQL, если мало перезапустить на всяких случай службы в крайнем случае серваки.
В 
любом случае перезапустить службы 1C агента и PostgreSQL чтобы убить фоновые процессы и активные подключенияПроверяем место на жестком диске сервера 1С должно быть достаточно для скачанных обновлений и разных кэшей которые будут грузиться в temp папки. Если мало, то чистим старые кэши 1С.
Запустил все базы в клиенте под админом.

	Обновление платформы и севера.

ПЕРЕД ОБНОВЛЕНИЕМ СЕРВЕРА 1С И ПЛАТФОРМЫ ЗАБЕКАПИТЬ НАСТРОЙКИ СЕРВЕРА 1С ПАПКА srvinfo
Обновление по факту выглядит так останавливаем агент сервера. Прям не забудьте так как могут сломаться обмены между базами если при установке не перезапишутся некоторые компоненты в реестр. В видео 02:44:00.
C:\Windows\system32>C:\Windows\SysWOW64\regsvr32 "C:\Program Files\1cv8\8.3.17.1496\bin\comcntr.dll"

Так же не забудь проверить что встали компоненты



Удаляем старый сервер и платформу средствами windows.
Удаляем мусор кеши и т.д. от старого сервера.
Устанавливаем новую версию сервака 1С и платформы и Администрирование сервера 1С.
Запускаем Регистрация утилиты администрирования серверов x86-64 (8.3.17.1496)
Готово.
Обновляем платформу у на всех клиентских машинах.

Обновление конфигураций баз через клиент в полуавтоматическом режиме. Работает плоховато. Часто не может закончить обновление.

Запускаем одну базу, включаем скачивание обновлений.
Запускаем обновления всех остальных баз.
Если есть затык на “Завершение работы пользователей”, то пробуем закрыть сеансы через Администрирование серверов 1С Предприятия x86-64 и через него же можно включить “Блокировка регламентных заданий включена”

Обновление конфигураций баз через конфигуратор в ручном режиме. (Довольно стабильный вариант).

Открываем конфигуратор.
Все базы открывать каскадом так, чтобы видеть нижний левый угол программы с состоянием обновления.
Проверить что конфигурация базы стандартная есть значок когда открываете конфигурацию.
Произвести обновление если все нормально с лицензией то прямо через конфигуратор скачиваем обновления. (Конфигурация - Поддержка - Обновить конфигурацию)
Когда конфигуратор закончит обновлять он ничего не напишет об успехе операции. Так что можно ориентироваться на левый нижний угол окна. Там появиться сообщение о вызове справки через клавишу F1. Так же в диспетчере задач не будет “Не отвечает” на задаче.
Закрываем все конфигураторы и окна 1С
Останавливаем и запускаем агент сервера снова. Чтобы не дай бог не забить всю оперативку.
После обновления в конфигураторе обязательно запустить клиент 1С, и продолжить обновление.
Увериться что оно завершило все фоновые задачи. (Администрирование - Обслуживание - Результаты обновления программы. Результаты обновления и дополнительные обработки.) Если этого не сделать то следующее обновление сломает базу. Если тут ничего не хочет работать, то проверить нет ли “Блокировки регламентных заданий” на этой базе.
Производим эту итерацию такое количество раз, сколько вышло обновлений конфигураций

Тестирование и обслуживание до и после обновлений.

После обновлений, как и перед ними стоит делать тестирование баз через конфигуратор.
Если есть затык на “Завершение работы пользователей” или просто не хотят запускать тестирование, то пробуем закрыть сеансы через Администрирование серверов 1С Предприятия x86-64 и через него же можно включить “Блокировка регламентных заданий включена”
Все базы стоит открывать в полном экране так будет поудобнее.
Так же строит провести операции обслуживания через PostgreSQL сервер ANALYZE, REINDEX, VACUUM.

Когда все пошло не так и все сломалось.
Восстановление баз из дампа sql (.backup) PostgreSQL

Остановить агент сервера 1С
Перезапустить сервер PostgreSQL
Глянуть коннекты какие висят к базам через PGadmin или запросом sql.
Создать чистую новую базу (лучше сразу с именем с каким она будет использоваться, если такие названия есть в названия старых сломанных баз дописываем _old_data и на ее место создаем чистую базу. Удалить старье лучше потом, ломать не строить)
Восстановить в чистую базу через restor в pgadmin  или скрипт. Иногда магическим образом восстановление работает только со второго раза.
Обязательно запустить базу 1С через клиент и если спосит принять что это база перемещена.
Не забываем после про обслуживание и тестирование базы.

	В дополнении про восстановление из .backup.
Также можно через 1С создать чистую базу.
Сделать её бэкап через постгрес.
Так у нас будет чистый дамп 1С с правильной структурой который мы можем использовать для быстрого восстановления баз через .dt (т.е. не придется каждый раз создавать базу через клиент 1С)

	Восстановление базы через конфигуратор 1С из .dt файлов.
Перезапустить агент сервера 1С
Создать через 1С клиент пустую базу на сервере 1С и Postgres.
Открыть через конфигуратор.
Загрузить в нее .dt

	Тюниг 1С

Регламентные работы в базах стоит уменьшить частоту выполнения.
Извлечение текста (умножал на 10)
Обновление ППД (умножал на 10)
Если проблемы с памятью на сервере, то делайте скрипты для удаления кэшей, обновлений старый и прочего хлама что генерит 1С и не убирает за собой.

	Тюнинг PostgreSQL 1C

Бекапить конфиг до начала любых изменений.
Не меняй в конфиге сразу много иногда может не стартануть служба.
Раскомментируйте строку! Иначе она не работает. Банально, но многие на этом спотыкаются.
Перезапускай службу после изменения конфига для её применения.
После сбоя питания через мин 30 сервер стартанет смотри в логах и журнале windows. Но доступа к службе может не быть, но доступ к базам через 1С будет. Тогда просто после старта службы (Увидишь сообщение в логах только в логах посгреса) Перезагрузить сервер корректно и все будет ок. После таких сбоев лучше тестировать базы через конфигуратор 1С и делать обслуживание средствами постгреса.

